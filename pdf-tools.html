<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PDF Tools - Local Processing</title>

    <link href="bootstrap/bootstrap.min.css" rel="stylesheet" />
    <!-- Tambahkan Bootstrap JS -->
    <script src="bootstrap/bootstrap.bundle.min.js"></script>
    <link href="bootstrap/bootstrap-icons.css" rel="stylesheet"/>
    <link href="bootstrap/bootstrap-icons.min.css" rel="stylesheet"/>
    <script src="lib/pdf-lib.min.js"></script>
    <script src="lib/download.min.js"></script>
    <script src="lib/xlsx.full.min.js"></script>
    <script src="lib/jspdf.umd.min.js"></script>
    <script src="lib/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="lib/all.min.css" />

    <style>
        :root {
            --dark-blue: #003366;
            --header-blue: #005073;
            --light-blue: #d7e8fa;
            --light-blue-filter: #f5f9ff;
            --white: #ffffff;
            --gray-border: #e0e0e0;
            --shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            --accent-blue: #0066cc;
            --accent-blue-hover: #0052a3;
            --success-green: #28a745;
            --danger-red: #dc3545;
            --warning-yellow: #ffc107;
            --info-cyan: #17a2b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Inter", sans-serif;
        }

        /* Make html and body take full viewport height */
        html,
        body {
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        /* Tambahkan container untuk background */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("img/walp1.jpg");
            background-size: cover;
            background-position: center;
            /* background-attachment: fixed; */
            z-index: -2;
        }

        /* Tambahkan overlay putih blur */
        body::after {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: -1;
        }

        body {
            color: var(--dark-blue);
            padding-top: 80px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Header Styling */
        .navbar-custom {
            background-color: var(--dark-blue);
            opacity: 1 !important;
            transform: none !important;
            animation: none !important;
            height: 60px;
        }

        .navbar-custom .fw-semibold {
            font-size: 16px;
            font-weight: 600;
        }

        .logo-img {
            height: 60px;
        }

        /* Main Content Layout */
        .main-content {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            gap: 20px;
            overflow: hidden;
            margin: 0;
            backdrop-filter: blur(2px);
            margin-top: 2%;
            overflow-y: auto;
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* IE and Edge */
        }

        .main-content::-webkit-scrollbar {
            display: none;
        }

        /* Tools Container */
        .tools-container {
            background: var(--light-blue-filter);
            border-radius: 10px;
            box-shadow: var(--shadow);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 0 10%;
            opacity: 0;
            animation: contentSlideUp 0.8s ease-out 0.3s forwards;
        }

        @keyframes contentSlideUp {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Tool Header */
        .tool-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--light-blue);
        }

        .tool-title {
            font-size: 22px;
            font-weight: 600;
            color: var(--dark-blue);
        }

        .tool-subtitle {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        /* Tools Grid */
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 5px;
        }

        .tool-card {
            background: var(--white);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            box-shadow: var(--shadow);
        }

        .tool-card:hover {
            transform: translateY(-3px);
            border-color: var(--accent-blue);
            box-shadow: 0 5px 15px rgba(0, 102, 204, 0.1);
        }

        .tool-card.active {
            border-color: var(--accent-blue);
            background: var(--light-blue);
        }

        .tool-icon {
            font-size: 32px;
            color: var(--accent-blue);
            margin-bottom: 10px;
        }

        .tool-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark-blue);
        }

        /* Workspace Area */
        .workspace-area {
            background: var(--white);
            border-radius: 8px;
            padding: 25px;
            border: 2px dashed var(--gray-border);
            min-height: 100px;
            position: relative;
            transition: all 0.3s ease;
        }

        .workspace-area.dragover {
            border-color: var(--accent-blue);
            background: rgba(0, 102, 204, 0.05);
        }

        /* Empty State */
        .empty-state {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #666;
        }

        .empty-state i {
            font-size: 48px;
            color: var(--accent-blue);
            margin-bottom: 15px;
            opacity: 0.6;
        }

        .empty-state p {
            font-size: 14px;
            margin-bottom: 5px;
        }

        /* File Preview - Style untuk semua mode */
        .file-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
        }

        .file-preview::-webkit-scrollbar {
            width: 6px;
        }

        .file-preview::-webkit-scrollbar-thumb {
            background: var(--light-blue);
            border-radius: 3px;
        }

        /* Page Preview - Style khusus untuk mode rearrange */
        .page-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            overflow-y: auto;
            padding: 15px;
        }

        .page-preview::-webkit-scrollbar {
            width: 8px;
        }

        .page-preview::-webkit-scrollbar-thumb {
            background: var(--light-blue);
            border-radius: 4px;
        }

        .page-card {
            background: var(--light-blue-filter);
            border-radius: 10px;
            padding: 20px;
            position: relative;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid var(--gray-border);
            cursor: move;
            user-select: none;
        }

        .page-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            border-color: var(--accent-blue);
        }

        .page-card.dragging {
            opacity: 0.5;
            border: 2px dashed var(--accent-blue);
            transform: scale(0.98);
        }

        .page-card.drag-over {
            border: 2px solid var(--accent-blue);
            background: rgba(0, 102, 204, 0.1);
        }

        .page-number {
            position: absolute;
            top: 10px;
            left: 10px;
            background: var(--accent-blue);
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .page-label {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark-blue);
            margin-bottom: 5px;
            padding-top: 10px;
        }

        .page-thumbnail {
            width: 40%;
            height: 50%;
            background: var(--white);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            margin-left: 52px;
            border: 1px solid var(--gray-border);
            overflow: hidden;
        }

        .page-thumbnail i {
            font-size: 48px;
            color: var(--accent-blue);
            opacity: 0.7;
        }

        .page-info {
            font-size: 12px;
            color: #666;
            background: var(--white);
            padding: 5px 10px;
            border-radius: 4px;
            margin-top: 5px;
            border: 1px solid var(--gray-border);
        }

        /* Hapus button untuk halaman */
        .page-delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--danger-red);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .page-card:hover .page-delete-btn {
            opacity: 1;
            transform: scale(1.1);
        }

        .page-delete-btn:hover {
            background: #c82333;
            transform: scale(1.2);
        }

        /* File Card (untuk mode lain) */
        .file-card {
            background: var(--light-blue-filter);
            border-radius: 8px;
            padding: 15px;
            position: relative;
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid var(--gray-border);
        }

        .file-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .file-icon {
            font-size: 28px;
            color: var(--danger-red);
            margin-bottom: 10px;
        }

        .file-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--dark-blue);
            word-break: break-all;
            margin-bottom: 5px;
            height: 32px;
            overflow: hidden;
        }

        .file-size {
            font-size: 10px;
            color: #666;
        }

        .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--danger-red);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .file-card:hover .remove-btn {
            opacity: 1;
        }

        /* Controls Section */
        .controls-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 20px;
            border-top: 2px solid var(--light-blue);
        }

        /* Tool Options */
        .tool-options {
            display: none;
            gap: 15px;
            align-items: center;
            background: var(--light-blue);
            padding: 5px;
            border-radius: 8px;
            margin-bottom: 5px;
        }

        .tool-options.active {
            display: flex;
            animation: filterFadeIn 0.5s ease-out;
        }

        @keyframes filterFadeIn {
            0% {
                opacity: 0;
                transform: translateY(15px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .option-label {
            font-weight: 600;
            color: var(--dark-blue);
            font-size: 14px;
        }

        .option-input {
            padding: 8px 12px;
            border: 1px solid var(--gray-border);
            border-radius: 6px;
            background: var(--white);
            font-weight: 600;
            color: var(--dark-blue);
            font-size: 14px;
            min-width: 200px;
        }

        .option-btn {
            padding: 8px 16px;
            background: var(--white);
            border: 1px solid var(--gray-border);
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            color: var(--dark-blue);
        }

        .option-btn:hover {
            background: var(--light-blue);
            border-color: var(--accent-blue);
        }

        /* Buttons */
        .btn-primary {
            background: var(--success-green);
            color: var(--white);
            border: none;
            padding: 5px 12px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary:hover {
            background: var(--accent-blue-hover);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--dark-blue);
            border: 1px solid var(--gray-border);
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary:hover {
            background: var(--light-blue);
            border-color: var(--accent-blue);
        }

        .btn-danger {
            background: var(--danger-red);
            color: var(--white);
            border: none;
            padding: 5px 10px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: var(--success-green);
            color: var(--white);
            border: none;
            padding: 5px 12px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-success:hover {
            background: var(--accent-blue-hover);
        }

        /* Loading Overlay */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            border-radius: 8px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--light-blue);
            border-top: 4px solid var(--header-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        .loading-text {
            color: var(--dark-blue);
            font-size: 14px;
            font-weight: 600;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* File Input */
        #fileInput {
            display: none;
        }

        /* Rotation Controls */
        .rotation-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .rotation-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark-blue);
            min-width: 40px;
            text-align: center;
        }

        /* Sort handle untuk file sorting */
        .sort-handle {
            position: absolute;
            top: 5px;
            left: 5px;
            color: #666;
            cursor: move;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .file-card:hover .sort-handle {
            opacity: 1;
        }

        .file-card.dragging .sort-handle {
            opacity: 1;
        }

        .file-order {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: var(--accent-blue);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }

        /* Instructions untuk rearrange mode */
        .instructions {
            background: var(--light-blue);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--accent-blue);
            transition: all 0.3s ease;
        }

        .instructions.collapsed {
            padding: 10px 15px;
        }

        .instructions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .instructions-title {
            color: var(--dark-blue);
            margin-bottom: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 600;
        }

        .instructions-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, margin-top 0.3s ease;
            margin-top: 0;
        }

        .instructions.expanded .instructions-content {
            max-height: 200px;
            margin-top: 15px;
        }

        .instructions-list {
            font-size: 13px;
            color: #555;
        }

        .instructions-list p {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .instructions-list i {
            color: var(--accent-blue);
            font-size: 14px;
            min-width: 20px;
        }

        .toggle-icon {
            transition: transform 0.3s ease;
        }

        .instructions.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        /* Page count display */
        .page-count {
            font-size: 14px;
            color: var(--dark-blue);
            font-weight: 600;
            margin-bottom: 10px;
            padding: 8px 15px;
            background: var(--light-blue);
            border-radius: 6px;
            display: inline-block;
        }

        /* Modern Alert Styles */
        .custom-alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .custom-alert-box {
            background: white;
            border-radius: 14px;
            padding: 2rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
            border: 1px solid #e0e0e0;
            animation: alertSlideIn 0.15s ease-out;
        }

        @keyframes alertSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .custom-alert-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .custom-alert-message {
            font-size: 1.1rem;
            margin-bottom: 2rem;
            color: #5a6c7d;
            line-height: 1.5;
        }

        .custom-alert-button {
            background: #003366;
            color: white;
            border: none;
            padding: 5px 20px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .custom-alert-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .custom-alert-button:active {
            transform: translateY(0);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .tools-container {
                margin: 0 5%;
            }

            .tools-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .controls-section {
                flex-direction: column;
                gap: 15px;
            }

            .tool-options {
                flex-direction: column;
                align-items: stretch;
            }

            .option-input {
                min-width: 100%;
            }

            .page-preview {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }

        /* Page order indicator */
        .new-order {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: var(--success-green);
            color: white;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: bold;
        }

        /* Original order indicator */
        .original-order {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: var(--warning-yellow);
            color: var(--dark-blue);
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: bold;
        }

        /* Delete confirmation */
        .delete-confirmation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .delete-modal {
            background: white;
            border-radius: 12px;
            padding: 25px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: alertSlideIn 0.15s ease-out;
        }

        .delete-modal h4 {
            color: var(--danger-red);
            margin-bottom: 15px;
            font-size: 18px;
        }

        .delete-modal p {
            color: #555;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .delete-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .delete-modal-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            min-width: 80px;
        }

        .delete-modal-btn.cancel {
            background: var(--light-blue);
            color: var(--dark-blue);
        }

        .delete-modal-btn.cancel:hover {
            background: #d1e0f0;
        }

        .delete-modal-btn.confirm {
            background: var(--danger-red);
            color: white;
        }

        .delete-modal-btn.confirm:hover {
            background: #c82333;
        }

        /* Style untuk halaman terpilih di mode rotate */
        .page-card.selected {
            border: 2px solid #28a745;
            background: rgba(40, 167, 69, 0.05);
        }

        .page-card.selected .page-thumbnail {
            border-color: #28a745;
        }

        /* Style untuk ikon rotasi */
        .bi-arrow-clockwise,
        .bi-arrow-counterclockwise,
        .bi-arrow-down-up {
            transition: all 0.3s ease;
        }

        /* Style untuk input halaman */
        #rotate-pages {
            transition: all 0.3s ease;
        }

        #rotate-pages:focus {
            border-color: #0066cc;
            box-shadow: 0 0 0 0.2rem rgba(0, 102, 204, 0.25);
        }

                /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--dark-blue);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #004080;
        }

    </style>
</head>

<body>
    <header class="navbar navbar-custom fixed-top shadow-sm px-3">
        <div class="d-flex align-items-center justify-content-center">
            <span class="fw-semibold text-white d-none d-sm-inline">PDF Tools - Local Processing</span>
        </div>
    </header>

 
    <div class="main-content">
        <div class="tools-container">
            <!-- Tool Header -->
            <div class="tool-header">
                <div>
                    <h2 class="tool-title" id="tool-title">Merge PDF</h2>
                </div>
                <button class="btn-secondary" onclick="document.getElementById('fileInput').click()">
                    <i class="bi bi-plus-circle"></i> Add File
                </button>
                <input type="file" id="fileInput" multiple style="display: none" onchange="handleFiles(this.files)" />
            </div>

            <!-- Tools Selection -->
            <div class="tools-grid">
                <div class="tool-card active" onclick="switchTool('merge')" title="Merge PDF">
                    <i class="bi bi-file-earmark-pdf-fill tool-icon"></i>
                    <div class="tool-name">Merge PDF</div>
                </div>
                <div class="tool-card" onclick="switchTool('split')" title="Split PDF">
                    <i class="bi bi-scissors tool-icon"></i>
                    <div class="tool-name">Split PDF</div>
                </div>
                <div class="tool-card" onclick="switchTool('rotate')" title="Rotate PDF">
                    <i class="bi bi-arrow-clockwise tool-icon"></i>
                    <div class="tool-name">Rotate PDF</div>
                </div>
                <div class="tool-card" onclick="switchTool('img2pdf')" title="JPG to PDF">
                    <i class="bi bi-image-fill tool-icon"></i>
                    <div class="tool-name">JPG to PDF</div>
                </div>
                <div class="tool-card" onclick="switchTool('xls2pdf')" title="Excel to PDF">
                    <i class="bi bi-file-earmark-excel-fill tool-icon"></i>
                    <div class="tool-name">Excel to PDF</div>
                </div>
                <div class="tool-card" onclick="switchTool('rearrange')" title="Rearrange Pages">
                    <i class="bi bi-arrows-move tool-icon"></i>
                    <div class="tool-name">Rearrange Pages</div>
                </div>
            </div>

            <!-- Tool Options -->
            <div id="opt-split" class="tool-options">
                <span class="option-label">Page:</span>
                <input type="text" id="split-range" class="option-input" placeholder="Example: 1-3, 5" />
                <span class="option-label" style="font-size: 12px; color: #666"> use comma to separate pages, dash for range</span>
            </div>

            <div id="opt-rotate" class="tool-options">
                <!-- Existing rotation controls -->
                <span class="option-label">Page:</span>
                <input type="text" id="rotate-pages" class="option-input" placeholder="All pages"
                    style="min-width: 150px; margin-right: 10px" />
                <span class="option-label">Rotation:</span>
                <div class="rotation-controls">
                    <button class="option-btn" onclick="setRotation(-90)" title="Rotate 90° left">
                        <i class="bi bi-arrow-counterclockwise"></i> -90°
                    </button>
                    <span class="rotation-value" id="rotation-val">0°</span>
                    <button class="option-btn" onclick="setRotation(90)" title="Rotate 90° right">
                        <i class="bi bi-arrow-clockwise"></i> +90°
                    </button>
                    <button class="option-btn" onclick="setRotation(180)" title="Rotate 180°" style="margin-left: 10px">
                        <i class="bi bi-arrow-down-up"></i> 180°
                    </button>
                    <button class="option-btn" onclick="resetRotation()" title="Reset rotation"
                        style="background: #f8f9fa">
                        <i class="bi bi-arrow-clockwise"></i> Reset
                    </button>
                    <button class="option-btn" onclick="resetToOriginalOrientation()" 
                            title="Reset to original orientation" style="background: #ffc107; color: #000;">
                        <i class="bi bi-arrow-counterclockwise"></i> Original
                    </button>
                </div>
            </div>

            <!-- Instructions untuk rearrange mode -->
            <div id="rearrange-instructions" class="instructions collapsed" style="display: none">
                <div class="instructions-header" onclick="toggleInstructions()">
                    <h5 class="instructions-title">
                        <i class="bi bi-info-circle"></i> How to use
                    </h5>
                    <i class="bi bi-chevron-down toggle-icon"></i>
                </div>
                <div class="instructions-content">
                    <div class="instructions-list">
                        <p>
                            <i class="bi bi-hand-index"></i> Drag & drop page to rearrange pages
                        </p>
                        <p>
                            <i class="bi bi-circle-fill" style="color: #0066cc"></i> Blue Number = new order
                        </p>
                        <p>
                            <i class="bi bi-circle-fill" style="color: #ffc107"></i> Yellow Number
                            = original order
                        </p>
                        <p>
                            <i class="bi bi-trash" style="color: #dc3545"></i> Click red X
                            to delete page
                        </p>
                        <p>
                            <i class="bi bi-file-earmark-check"></i> Process to create
                            PDF with new order
                        </p>
                    </div>
                </div>
            </div>

            <!-- Workspace Area -->
            <div class="workspace-area" id="dropZone">
                <!-- Empty State -->
                <div class="empty-state" id="emptyState">
                    <i class="bi bi-cloud-arrow-up"></i>
                    <p>Drag & Drop file here</p>
                </div>

                <!-- File Preview Area untuk mode selain rearrange -->
                <div class="file-preview" id="previewArea" style="display: none">
                    <!-- File cards will be inserted here -->
                </div>

                <!-- Page Preview Area untuk mode rearrange -->
                <div class="page-preview" id="pagePreviewArea" style="display: none">
                    <!-- Page cards will be inserted here -->
                </div>

                <!-- Loading Overlay -->
                <div class="loading-overlay" id="loading">
                    <div class="loading-spinner"></div>
                    <p class="loading-text" id="loading-text">Processing...</p>
                </div>
            </div>

            <!-- Controls Section -->
            <div class="controls-section">
                <div class="control-group">
                    <button class="btn-danger" onclick="clearAll()">
                        <i class="bi bi-trash"></i> Clear All
                    </button>
                </div>
                <div class="control-group">
                    <button class="btn-primary" onclick="processFiles()" id="processBtn">
                        <i class="bi bi-gear"></i> Process & Download
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmation" class="delete-confirmation" style="display: none">
        <div class="delete-modal">
            <h4><i class="bi bi-exclamation-triangle"></i> Delete Page</h4>
            <p id="deleteMessage">
                Are you sure you want to delete this page? This action cannot be undone.
            </p>
            <div class="delete-modal-buttons">
                <button class="delete-modal-btn cancel" onclick="cancelDelete()">
                    Cancel
                </button>
                <button class="delete-modal-btn confirm" onclick="confirmDelete()">
                    Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Alert Container -->
    <div id="customAlert" class="custom-alert-overlay" style="display: none">
        <div class="custom-alert-box">
            <h3 class="custom-alert-title" id="alertTitle">Notification</h3>
            <div class="custom-alert-message" id="alertMessage">
                Message will appear here
            </div>
            <button class="custom-alert-button" id="alertButton">OK</button>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE ---
        let currentTool = "merge";
        let filesData = []; // { file: File, id: timestamp, rotation: 0 }
        let rotationAngle = 0;
        let draggedItem = null;

        // State khusus untuk rotate mode
        let pageRotations = new Map(); // Map untuk menyimpan rotasi per halaman {pageIndex: angle}
        let selectedPagesForRotation = []; // Array halaman yang dipilih untuk diputar

        // State khusus untuk rearrange mode
        let pageOrder = []; // Array berisi urutan halaman [0, 1, 2, ...]
        let originalPageCount = 0;
        let pdfDoc = null; // Untuk menyimpan PDF document di mode rearrange

        // State untuk hapus halaman
        let pageToDelete = null; // Menyimpan index halaman yang akan dihapus

        const { PDFDocument, degrees } = PDFLib;

        // --- CUSTOM ALERT FUNCTION ---
        function showCustomAlert(title, message) {
            return new Promise((resolve) => {
                const alertOverlay = document.getElementById("customAlert");
                const alertTitle = document.getElementById("alertTitle");
                const alertMessage = document.getElementById("alertMessage");
                const alertButton = document.getElementById("alertButton");

                // Set content
                alertTitle.textContent = title;
                alertMessage.textContent = message;

                // Show alert
                alertOverlay.style.display = "flex";

                // Handle button click
                function handleClick() {
                    alertOverlay.style.display = "none";
                    alertButton.removeEventListener("click", handleClick);
                    resolve(true);
                }

                alertButton.addEventListener("click", handleClick);

                // Close on overlay click (optional)
                alertOverlay.addEventListener("click", function (e) {
                    if (e.target === alertOverlay) {
                        handleClick();
                    }
                });
            });
        }

        // Replace all standard alert calls with custom alert
        const originalAlert = window.alert;
        window.alert = function (message) {
            showCustomAlert("Notification", message);
        };

        // --- FUNGSI INSTRUCTIONS ---
        function toggleInstructions() {
            const instructions = document.getElementById("rearrange-instructions");
            instructions.classList.toggle("expanded");
            instructions.classList.toggle("collapsed");
        }

        // --- UI LOGIC ---
        function switchTool(tool, event = null) {
            currentTool = tool;

            // Update active tool card
            if (event) {
                document
                    .querySelectorAll(".tool-card")
                    .forEach((el) => el.classList.remove("active"));
                event.currentTarget.classList.add("active");
            } else {
                // Fallback: update berdasarkan tool name
                document
                    .querySelectorAll(".tool-card")
                    .forEach((el) => el.classList.remove("active"));
                const toolCards = document.querySelectorAll(".tool-card");
                const toolIndex = {
                    merge: 0,
                    split: 1,
                    rotate: 2,
                    img2pdf: 3,
                    xls2pdf: 4,
                    rearrange: 5,
                };
                if (toolCards[toolIndex[tool]]) {
                    toolCards[toolIndex[tool]].classList.add("active");
                }
            }

            // Update titles
            const titles = {
                merge: "Merge PDF Files",
                split: "Split PDF File",
                rotate: "Rotate PDF Pages",
                img2pdf: "Convert JPG to PDF",
                xls2pdf: "Convert Excel to PDF",
                rearrange: "Rearrange PDF Pages",
            };
            document.getElementById("tool-title").innerText = titles[tool];

            // Toggle options visibility
            document
                .querySelectorAll(".tool-options")
                .forEach((el) => el.classList.remove("active"));

            if (tool === "split") {
                document.getElementById("opt-split").classList.add("active");
                document.getElementById("split-range").placeholder =
                    "Example: 1-3, 5, 7-9";
            }

            if (tool === "rotate") {
                document.getElementById("opt-rotate").classList.add("active");
                rotationAngle = 0;
                document.getElementById("rotation-val").innerText = "0°";

                // Reset state rotasi
                pageRotations.clear();
                selectedPagesForRotation = [];
                document.getElementById("rotate-pages").value = "";

                // Jika ada file PDF yang sudah diupload, render preview khusus untuk rotate
                if (
                    filesData.length > 0 &&
                    filesData[0].file.type === "application/pdf"
                ) {
                    loadPDFForRotate(filesData[0].file);
                }
            }

            // Tampilkan/sembunyikan instructions untuk rearrange mode
            const instructions = document.getElementById("rearrange-instructions");
            if (tool === "rearrange") {
                instructions.style.display = "block";
                // Set instructions collapsed by default
                instructions.classList.remove("expanded");
                instructions.classList.add("collapsed");
            } else {
                instructions.style.display = "none";
            }

            // Update tombol proses
            const processBtn = document.getElementById("processBtn");
            if (tool === "rearrange") {
                processBtn.innerHTML =
                    '<i class="bi bi-check-circle"></i> Process & Download';
                processBtn.className = "btn-success";
            } else {
                processBtn.innerHTML = '<i class="bi bi-gear"></i> Process & Download';
                processBtn.className = "btn-primary";
            }

            // Validate existing files for new tool
            validateFilesForCurrentTool();

            // Re-render files untuk menyesuaikan dengan tool
            renderFiles();
        }

        // --- FILE VALIDATION ---
        function validateFilesForCurrentTool() {
            if (filesData.length === 0) return;

            let valid = true;
            let errorMessage = "";

            switch (currentTool) {
                case "split":
                case "rotate":
                    if (filesData.length > 1) {
                        errorMessage = `Mode "${getToolName(
                            currentTool
                        )}" only accepts 1 PDF file. Only the first file will be processed.`;
                        filesData = filesData.slice(0, 1);
                        valid = false;
                    }
                    // Untuk mode rotate, pastikan file adalah PDF
                    if (filesData.length > 0) {
                        const item = filesData[0];
                        if (item.file.type !== "application/pdf") {
                            errorMessage = "Mode 'Rotate PDF' only accepts PDF files.";
                            filesData = [];
                            valid = false;
                        } else {
                            // Load PDF untuk mendapatkan jumlah halaman
                            loadPDFForRotate(item.file);
                        }
                    }
                    break;
                case "rearrange":
                    if (filesData.length > 1) {
                        errorMessage = `Mode "${getToolName(
                            currentTool
                        )}" only accepts 1 PDF file. Only the first file will be processed.`;
                        filesData = filesData.slice(0, 1);
                        valid = false;
                    }
                    // Untuk mode rearrange, pastikan file adalah PDF
                    if (currentTool === "rearrange" && filesData.length > 0) {
                        const item = filesData[0];
                        if (item.file.type !== "application/pdf") {
                            errorMessage = "Mode 'Rearrange Pages' only accepts PDF files.";
                            filesData = [];
                            valid = false;
                        } else {
                            // Load PDF untuk mendapatkan jumlah halaman
                            loadPDFForRearrange(item.file);
                        }
                    }
                    break;
                case "img2pdf":
                    const invalidImages = filesData.filter(
                        (item) => !item.file.type.startsWith("image/")
                    );
                    if (invalidImages.length > 0) {
                        errorMessage =
                            "Only image files (JPG/PNG) are allowed for this mode.";
                        filesData = filesData.filter((item) =>
                            item.file.type.startsWith("image/")
                        );
                        valid = false;
                    }

                    // Tambahkan informasi tentang drag & drop sorting
                    if (filesData.length > 1) {
                        errorMessage +=
                            "\n\nYou can sort images by dragging and dropping them.";
                    }
                    break;
                case "xls2pdf":
                    const invalidExcel = filesData.filter(
                        (item) => !item.file.name.match(/\.(xlsx|xls)$/)
                    );
                    if (invalidExcel.length > 0) {
                        errorMessage =
                            "Only Excel (.xlsx/.xls) files are allowed for this mode.";
                        filesData = filesData.filter((item) =>
                            item.file.name.match(/\.(xlsx|xls)$/)
                        );
                        valid = false;
                    }
                    break;
                default: // merge
                    const invalidPDFs = filesData.filter(
                        (item) => item.file.type !== "application/pdf"
                    );
                    if (invalidPDFs.length > 0) {
                        errorMessage = "Only PDF files are allowed for this mode.";
                        filesData = filesData.filter(
                            (item) => item.file.type === "application/pdf"
                        );
                        valid = false;
                    }
            }

            if (!valid && errorMessage) {
                showCustomAlert("Warning", errorMessage);
                renderFiles();
            }
        }

        function getToolName(tool) {
            const names = {
                merge: "Merge PDF",
                split: "Split PDF",
                rotate: "Rotate PDF",
                img2pdf: "JPG to PDF",
                xls2pdf: "Excel to PDF",
                rearrange: "Rearrange Pages",
            };
            return names[tool] || tool;
        }

        // --- DRAG & DROP & FILE HANDLING ---
        const dropZone = document.getElementById("dropZone");

        dropZone.addEventListener("dragover", (e) => {
            e.preventDefault();
            dropZone.classList.add("dragover");
        });

        dropZone.addEventListener("dragleave", () =>
            dropZone.classList.remove("dragover")
        );

        dropZone.addEventListener("drop", (e) => {
            e.preventDefault();
            dropZone.classList.remove("dragover");
            handleFiles(e.dataTransfer.files);
        });

        function handleFiles(files) {
            if (!files.length) return;

            // Untuk mode rearrange, hanya terima 1 file
            if (currentTool === "rearrange" && files.length > 1) {
                showCustomAlert(
                    "Warning",
                    "Mode 'Rearrange Pages' only accepts 1 PDF file. Only the first file will be processed."
                );
                files = [files[0]];
            }

            // Clear existing files jika mode rearrange
            if (currentTool === "rearrange") {
                filesData = [];
                pageOrder = [];
                pdfDoc = null;
                originalPageCount = 0;
            }

            Array.from(files).forEach((file, index) => {
                // Untuk mode split/rotate/rearrange, hanya proses file pertama
                if (
                    (currentTool === "split" ||
                        currentTool === "rotate" ||
                        currentTool === "rearrange") &&
                    index > 0
                )
                    return;

                // Add to state
                const id = Date.now() + Math.random();
                filesData.push({ file, id });

                // Untuk mode rearrange, load PDF untuk mendapatkan halaman
                if (currentTool === "rearrange" && file.type === "application/pdf") {
                    loadPDFForRearrange(file);
                }

                // Untuk mode rotate, load PDF untuk mendapatkan halaman
                if (currentTool === "rotate" && file.type === "application/pdf") {
                    loadPDFForRotate(file);
                }
            });

            renderFiles();
        }

        // --- FUNGSI KHUSUS UNTUK REARRANGE MODE ---
        async function loadPDFForRearrange(file) {
            try {
                showLoading(true);
                document.getElementById("loading-text").innerText =
                    "Loading PDF pages...";

                const arrayBuffer = await file.arrayBuffer();
                pdfDoc = await PDFDocument.load(arrayBuffer);
                originalPageCount = pdfDoc.getPageCount();

                // Inisialisasi urutan halaman [0, 1, 2, ...]
                pageOrder = Array.from({ length: originalPageCount }, (_, i) => i);

                // Render preview halaman
                renderPagePreview();
                showLoading(false);
            } catch (error) {
                console.error("Error loading PDF for rearrange:", error);
                showCustomAlert(
                    "Error",
                    "Failed to load PDF file: " + error.message
                );
                showLoading(false);
                filesData = [];
                renderFiles();
            }
        }

        // --- FUNGSI KHUSUS UNTUK ROTATE MODE ---
// --- FUNGSI KHUSUS UNTUK ROTATE MODE (DIMODIFIKASI) ---
async function loadPDFForRotate(file) {
    try {
        showLoading(true);
        document.getElementById("loading-text").innerText = 
            "Loading and analyzing PDF pages...";

        const arrayBuffer = await file.arrayBuffer();
        const loadedPdf = await PDFDocument.load(arrayBuffer);
        const totalPages = loadedPdf.getPageCount();
        const pages = loadedPdf.getPages();

        // Analisis setiap halaman untuk deteksi rotasi bawaan
        const autoCorrections = [];
        
        // Inisialisasi rotasi untuk semua halaman
        for (let i = 0; i < totalPages; i++) {
            // Deteksi rotasi bawaan
            const detectedRotation = await detectPageRotation(pages[i]);
            
            // Simpan rotasi terdeteksi (negatif karena PDFLib menggunakan arah berbeda)
            const correctedRotation = -detectedRotation;
            pageRotations.set(i, correctedRotation);
            
            if (detectedRotation !== 0) {
                autoCorrections.push({
                    page: i + 1,
                    rotation: detectedRotation,
                    corrected: correctedRotation
                });
            }
        }

        // Inisialisasi selectedPagesForRotation dengan semua halaman
        selectedPagesForRotation = Array.from({ length: totalPages }, (_, i) => i);
        
        // Tampilkan notifikasi jika ada koreksi otomatis
        if (autoCorrections.length > 0) {
            setTimeout(() => {
                let message = `✅ Found ${autoCorrections.length} pages with default rotation:\n\n`;
                autoCorrections.slice(0, 5).forEach(corr => {
                    message += `• Page ${corr.page}: ${corr.rotation}° → corrected to ${corr.corrected}°\n`;
                });
                
                if (autoCorrections.length > 5) {
                    message += `• ...and ${autoCorrections.length - 5} other pages\n`;
                }
                
                message += "\nClick 'Reset' to revert to original orientation.";
                
                showCustomAlert("Automatic Correction", message);
            }, 500);
        }

        // Render preview khusus untuk rotate
        renderRotatePreview();
        showLoading(false);
    } catch (error) {
        console.error("Error loading PDF for rotate:", error);
        showCustomAlert("Error", "Failed to load PDF file: " + error.message);
        showLoading(false);
        filesData = [];
        renderFiles();
    }
}

        function renderRotatePreview() {
            const fileArea = document.getElementById("previewArea");
            const pageArea = document.getElementById("pagePreviewArea");

            // Reset semua area preview
            fileArea.innerHTML = "";
            pageArea.innerHTML = "";

            if (filesData.length === 0 || !pageRotations.size) {
                document.getElementById("emptyState").style.display = "block";
                fileArea.style.display = "none";
                pageArea.style.display = "none";
                return;
            }

            // Sembunyikan empty state
            document.getElementById("emptyState").style.display = "none";

            // Tampilkan area page preview untuk rotate mode
            pageArea.style.display = "grid";
            fileArea.style.display = "none";

            // Tampilkan info jumlah halaman
            const pageCountInfo = document.createElement("div");
            pageCountInfo.className = "page-count";
            pageCountInfo.innerHTML = `<i class="bi bi-file-earmark-text"></i> Total: ${pageRotations.size} pages`;
            pageArea.appendChild(pageCountInfo);

            // Buat card untuk setiap halaman
            Array.from(pageRotations.keys()).forEach((pageIndex) => {
                const rotationAngle = pageRotations.get(pageIndex) || 0;
                const isSelected = selectedPagesForRotation.includes(pageIndex);

                const card = document.createElement("div");
                card.className = `page-card ${isSelected ? "selected" : ""}`;
                card.setAttribute("data-index", pageIndex);
                card.setAttribute("data-rotation", rotationAngle);

                // Tentukan ikon rotasi berdasarkan angle
                let rotationIcon = "bi-arrow-clockwise";
                if (rotationAngle === 90 || rotationAngle === -270)
                    rotationIcon = "bi-arrow-clockwise";
                if (rotationAngle === -90 || rotationAngle === 270)
                    rotationIcon = "bi-arrow-counterclockwise";
                if (rotationAngle === 180 || rotationAngle === -180)
                    rotationIcon = "bi-arrow-down-up";

               // Di dalam renderRotatePreview(), modifikasi card HTML:
                card.innerHTML = `
                    <div class="page-number" style="${isSelected ? "background: #28a745;" : "background: #dc3545;"}">
                        ${pageIndex + 1}
                    </div>
                    <div class="page-thumbnail" style="transform: rotate(${rotationAngle}deg); transition: transform 0.3s;">
                        <i class="bi ${rotationIcon}" style="font-size: 32px; color: ${rotationAngle !== 0 ? "#0066cc" : "#999"}"></i>
                    </div>
                    <div class="page-label">Page ${pageIndex + 1}</div>
                    <div class="original-order" style="background: ${rotationAngle !== 0 ? "#28a745" : "#ffc107"}; 
                        color: ${rotationAngle !== 0 ? "white" : "#333"}">
                        <i class="bi ${rotationIcon}"></i> ${rotationAngle}°
                    </div>
                    <div class="page-info">
                        <small>Klik untuk ${isSelected ? 'batalkan' : 'pilih'}</small>
                    </div>
                `;

                // Tambahkan event listener untuk memilih halaman
                card.addEventListener("click", function (e) {
                    if (!e.target.classList.contains("page-delete-btn")) {
                        togglePageSelection(pageIndex);
                    }
                });

                pageArea.appendChild(card);
            });

            // Tambahkan instruksi
            const instructions = document.createElement("div");
            instructions.className = "instructions";
            instructions.style.marginTop = "10px";
            instructions.innerHTML = `
        <div class="instructions-header" onclick="toggleRotateInstructions(this)">
            <h5 class="instructions-title">
                <i class="bi bi-info-circle"></i> How to use
            </h5>
            <i class="bi bi-chevron-down toggle-icon"></i>
        </div>
        <div class="instructions-content">
            <div class="instructions-list">
                <p><i class="bi bi-check-circle" style="color: #28a745;"></i> Click page to select (green = selected)</p>
                <p><i class="bi bi-arrow-clockwise" style="color: #0066cc;"></i> Set rotation degree with +/-90° or 180° buttons</p>
                <p><i class="bi bi-keyboard" style="color: #17a2b8;"></i> Or type directly in input field (e.g., 1-3,5,7-9)</p>
                <p><i class="bi bi-file-earmark-check" style="color: #28a745;"></i> Process to apply rotation to PDF</p>
            </div>
        </div>
    `;
            pageArea.appendChild(instructions);
        }

        function toggleRotateInstructions(element) {
            const instructions = element.closest(".instructions");
            instructions.classList.toggle("expanded");
            instructions.classList.toggle("collapsed");

            const icon = element.querySelector(".toggle-icon");
            icon.classList.toggle("bi-chevron-down");
            icon.classList.toggle("bi-chevron-up");
        }

        function togglePageSelection(pageIndex) {
            const index = selectedPagesForRotation.indexOf(pageIndex);
            if (index === -1) {
                selectedPagesForRotation.push(pageIndex);
            } else {
                selectedPagesForRotation.splice(index, 1);
            }

            // Update tampilan
            renderRotatePreview();

            // Update input halaman
            updatePagesInputFromSelection();
        }

        function updatePagesInputFromSelection() {
            if (selectedPagesForRotation.length === 0) {
                document.getElementById("rotate-pages").value = "";
                return;
            }

            // Sort halaman terpilih
            const sortedPages = [...selectedPagesForRotation].sort((a, b) => a - b);

            // Buat string range
            let ranges = [];
            let start = sortedPages[0];
            let end = sortedPages[0];

            for (let i = 1; i <= sortedPages.length; i++) {
                if (i < sortedPages.length && sortedPages[i] === end + 1) {
                    end = sortedPages[i];
                } else {
                    if (start === end) {
                        ranges.push(start + 1); // +1 karena halaman dimulai dari 1 untuk user
                    } else {
                        ranges.push(`${start + 1}-${end + 1}`);
                    }

                    if (i < sortedPages.length) {
                        start = sortedPages[i];
                        end = sortedPages[i];
                    }
                }
            }

            document.getElementById("rotate-pages").value = ranges.join(", ");
        }

        // Event listener untuk input halaman
        document.addEventListener("DOMContentLoaded", function () {
            const pagesInput = document.getElementById("rotate-pages");

            pagesInput.addEventListener("blur", function () {
                parsePagesInput(this.value);
            });

            pagesInput.addEventListener("keypress", function (e) {
                if (e.key === "Enter") {
                    parsePagesInput(this.value);
                }
            });
        });

        function parsePagesInput(input) {
            const value = input.trim();
            if (!value) {
                // Jika kosong, pilih semua halaman
                selectedPagesForRotation = Array.from(pageRotations.keys());
                renderRotatePreview();
                return;
            }

            const totalPages = pageRotations.size;
            const selected = new Set();

            try {
                const parts = value.split(",");

                for (const part of parts) {
                    const trimmed = part.trim();
                    if (!trimmed) continue;

                    if (trimmed.includes("-")) {
                        // Handle range
                        const [startStr, endStr] = trimmed
                            .split("-")
                            .map((s) => s.trim());
                        const start = parseInt(startStr) - 1; // Convert to 0-index
                        const end = parseInt(endStr) - 1; // Convert to 0-index

                        if (isNaN(start) || isNaN(end) || start < 0 || end < 0) {
                            throw new Error(`Range not valid: ${trimmed}`);
                        }

                        if (start > end) {
                            throw new Error(`Range not valid: ${start + 1} > ${end + 1}`);
                        }

                        if (end >= totalPages) {
                            throw new Error(
                                `Page ${end + 1} exceeds total pages (${totalPages})`
                            );
                        }

                        for (let i = start; i <= end; i++) {
                            selected.add(i);
                        }
                    } else {
                        // Handle single page
                        const pageNum = parseInt(trimmed) - 1; // Convert to 0-index

                        if (isNaN(pageNum) || pageNum < 0) {
                            throw new Error(`Halaman tidak valid: ${trimmed}`);
                        }

                        if (pageNum >= totalPages) {
                            throw new Error(
                                `Halaman ${pageNum + 1
                                } melebihi total halaman (${totalPages})`
                            );
                        }

                        selected.add(pageNum);
                    }
                }

                selectedPagesForRotation = Array.from(selected);
                renderRotatePreview();
            } catch (error) {
                showCustomAlert(
                    "Format Tidak Valid",
                    `Error: ${error.message}\n\nFormat yang benar:\n• 1-3 (halaman 1 sampai 3)\n• 1,3,5 (halaman 1, 3, dan 5)\n• 1-3,5-7 (halaman 1-3 dan 5-7)\n• Kosongkan untuk semua halaman`
                );

                // Reset ke semua halaman
                selectedPagesForRotation = Array.from(pageRotations.keys());
                document.getElementById("rotate-pages").value = "";
                renderRotatePreview();
            }
        }

        function renderPagePreview() {
            const area = document.getElementById("pagePreviewArea");
            area.innerHTML = "";

            if (!pdfDoc || pageOrder.length === 0) {
                document.getElementById("emptyState").style.display = "block";
                return;
            }

            // Sembunyikan empty state
            document.getElementById("emptyState").style.display = "none";

            // Tampilkan jumlah halaman
            const pageCountInfo = document.createElement("div");
            pageCountInfo.className = "page-count";
            pageCountInfo.innerHTML = `<i class="bi bi-file-earmark-text"></i> Total: ${originalPageCount} halaman | Tersisa: ${pageOrder.length} halaman`;
            area.appendChild(pageCountInfo);

            // Buat card untuk setiap halaman
            pageOrder.forEach((pageIndex, newIndex) => {
                const card = document.createElement("div");
                card.className = "page-card";
                card.setAttribute("data-index", pageIndex);
                card.setAttribute("data-new-index", newIndex);
                card.setAttribute("draggable", "true");

                card.innerHTML = `
                    <button class="page-delete-btn" onclick="showDeleteConfirmation(${pageIndex})" title="Hapus halaman">
                        <i class="bi bi-x"></i>
                    </button>
                    <div class="page-number">${newIndex + 1}</div>
                    <div class="page-thumbnail">
                        <i class="bi bi-file-earmark-pdf"></i>
                    </div>
                    <div class="page-label">Page ${pageIndex + 1}</div>
                    <div class="original-order">Original: ${pageIndex + 1}</div>
                    <div class="new-order">New: ${newIndex + 1}</div>
                    <div class="page-info">
                        <i class="bi bi-arrows-move"></i> Drag to move
                    </div>
                `;

                area.appendChild(card);
            });

            // Setup drag and drop untuk halaman
            setupPageDragAndDrop();

            // Tampilkan area preview halaman
            document.getElementById("previewArea").style.display = "none";
            area.style.display = "grid";
        }

        // --- FUNGSI HAPUS HALAMAN ---
        function showDeleteConfirmation(pageIndex) {
            pageToDelete = pageIndex;
            const deleteMessage = document.getElementById("deleteMessage");
            deleteMessage.textContent = `Are you sure you want to delete page ${pageIndex + 1}? This action cannot be undone.`;
            document.getElementById("deleteConfirmation").style.display = "flex";
        }

        function cancelDelete() {
            document.getElementById("deleteConfirmation").style.display = "none";
            pageToDelete = null;
        }

        function confirmDelete() {
            if (pageToDelete !== null) {
                // Hapus halaman dari pageOrder
                const indexToRemove = pageOrder.indexOf(pageToDelete);
                if (indexToRemove !== -1) {
                    pageOrder.splice(indexToRemove, 1);
                    renderPagePreview();
                }

                // Tampilkan alert jika hanya tersisa 1 halaman
                if (pageOrder.length === 1) {
                    showCustomAlert(
                        "Warning",
                        "Only 1 page remains. You cannot delete the last page."
                    );
                }
            }

            // Tutup modal konfirmasi
            document.getElementById("deleteConfirmation").style.display = "none";
            pageToDelete = null;
        }

        // Setup drag and drop untuk halaman
        function setupPageDragAndDrop() {
            const cards = document.querySelectorAll(".page-card");
            let draggedCard = null;

            cards.forEach((card) => {
                card.addEventListener("dragstart", function (e) {
                    draggedCard = this;
                    this.classList.add("dragging");
                    e.dataTransfer.effectAllowed = "move";

                    // Gunakan dataTransfer untuk Firefox
                    e.dataTransfer.setData(
                        "text/plain",
                        this.getAttribute("data-index")
                    );
                });

                card.addEventListener("dragend", function () {
                    this.classList.remove("dragging");
                    draggedCard = null;
                    cards.forEach((c) => c.classList.remove("drag-over"));
                });

                card.addEventListener("dragover", function (e) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = "move";
                });

                card.addEventListener("dragenter", function (e) {
                    e.preventDefault();
                    if (this !== draggedCard) {
                        this.classList.add("drag-over");
                    }
                });

                card.addEventListener("dragleave", function () {
                    this.classList.remove("drag-over");
                });

                card.addEventListener("drop", function (e) {
                    e.preventDefault();
                    this.classList.remove("drag-over");

                    if (draggedCard && draggedCard !== this) {
                        const draggedIndex = parseInt(
                            draggedCard.getAttribute("data-index")
                        );
                        const targetIndex = parseInt(this.getAttribute("data-index"));

                        // Pindahkan halaman dalam pageOrder array
                        const draggedArrayIndex = pageOrder.indexOf(draggedIndex);
                        const targetArrayIndex = pageOrder.indexOf(targetIndex);

                        // Hapus dari posisi lama
                        pageOrder.splice(draggedArrayIndex, 1);
                        // Sisipkan di posisi baru
                        pageOrder.splice(targetArrayIndex, 0, draggedIndex);

                        // Render ulang preview
                        renderPagePreview();
                    }
                });
            });
        }

        // --- RENDER FILES UNTUK MODE LAIN ---
        function renderFiles() {
            const fileArea = document.getElementById("previewArea");
            const pageArea = document.getElementById("pagePreviewArea");

            // Reset semua area preview
            fileArea.innerHTML = "";
            pageArea.innerHTML = "";
            pageArea.style.display = "none";

            if (filesData.length === 0) {
                document.getElementById("emptyState").style.display = "block";
                fileArea.style.display = "none";
                return;
            }

            // Sembunyikan empty state
            document.getElementById("emptyState").style.display = "none";

            // Tampilkan area yang sesuai berdasarkan mode
            if (currentTool === "rearrange") {
                // Untuk mode rearrange, tampilkan page preview jika PDF sudah diload
                if (pdfDoc && pageOrder.length > 0) {
                    renderPagePreview();
                } else {
                    fileArea.style.display = "none";
                    // Tampilkan file info saja
                    const file = filesData[0];
                    const infoDiv = document.createElement("div");
                    infoDiv.className = "page-count";
                    infoDiv.innerHTML = `<i class="bi bi-file-earmark-pdf"></i> ${file.file.name
                        } (${(file.file.size / 1024 / 1024).toFixed(2)} MB)`;
                    pageArea.appendChild(infoDiv);
                    pageArea.style.display = "grid";
                }
            } else if (currentTool === "rotate") {
                // Untuk mode rotate, tampilkan preview khusus
                if (pageRotations.size > 0) {
                    renderRotatePreview();
                }
            } else {
                // Untuk mode lainnya, tampilkan file preview biasa
                fileArea.style.display = "grid";
                pageArea.style.display = "none";

                filesData.forEach((item, index) => {
                    const card = document.createElement("div");
                    card.className = "file-card";
                    card.setAttribute("data-id", item.id);
                    card.innerHTML = `
                <button class="remove-btn" data-id="${item.id}">
                    <i class="bi bi-x"></i>
                </button>
                <div class="file-icon">
                    <i class="bi ${getFileIcon(item.file.name)}"></i>
                </div>
                <div class="file-name" title="${item.file.name}">${item.file.name
                        }</div>
                <div class="file-size">${(item.file.size / 1024 / 1024).toFixed(
                            2
                        )} MB</div>
                <div class="file-order">${index + 1}</div>
                ${currentTool === "merge" || currentTool === "img2pdf"
                            ? '<div class="sort-handle"><i class="bi bi-grip-vertical"></i></div>'
                            : ""
                        }
            `;
                    fileArea.appendChild(card);
                });

                // Tambahkan event listener untuk remove button
                fileArea.querySelectorAll(".remove-btn").forEach((btn) => {
                    btn.addEventListener("click", function (e) {
                        e.stopPropagation();
                        const id = this.getAttribute("data-id");
                        removeFile(id);
                    });
                });

                // Aktifkan sortable untuk mode merge dan img2pdf
                if (currentTool === "merge" || currentTool === "img2pdf") {
                    makeFilesSortable();
                }
            }
        }

        function getFileIcon(filename) {
            if (filename.endsWith(".pdf")) return "bi-file-earmark-pdf";
            if (filename.match(/\.(jpg|jpeg|png|gif)$/))
                return "bi-file-earmark-image";
            if (filename.match(/\.(xlsx|xls)$/)) return "bi-file-earmark-excel";
            return "bi-file-earmark";
        }

        // --- DRAG & DROP SORTING UNTUK FILE (mode merge dan img2pdf) ---
        function makeFilesSortable() {
            const area = document.getElementById("previewArea");

            area.querySelectorAll(".file-card").forEach((card) => {
                card.setAttribute("draggable", "true");

                card.addEventListener("dragstart", (e) => {
                    draggedItem = card;
                    card.classList.add("dragging");
                    e.dataTransfer.effectAllowed = "move";
                });

                card.addEventListener("dragend", () => {
                    card.classList.remove("dragging");
                    draggedItem = null;
                    // Update urutan filesData berdasarkan posisi di DOM
                    updateFilesOrder();
                });

                card.addEventListener("dragover", (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = "move";
                });

                card.addEventListener("dragenter", (e) => {
                    e.preventDefault();
                    if (card !== draggedItem) {
                        card.classList.add("drag-over");
                    }
                });

                card.addEventListener("dragleave", () => {
                    card.classList.remove("drag-over");
                });

                card.addEventListener("drop", (e) => {
                    e.preventDefault();
                    card.classList.remove("drag-over");

                    if (draggedItem && draggedItem !== card) {
                        const allCards = Array.from(area.querySelectorAll(".file-card"));
                        const draggedIndex = allCards.indexOf(draggedItem);
                        const targetIndex = allCards.indexOf(card);

                        if (draggedIndex < targetIndex) {
                            card.after(draggedItem);
                        } else {
                            card.before(draggedItem);
                        }

                        // Update urutan langsung setelah drop
                        updateFilesOrder();
                    }
                });
            });
        }

        function updateFilesOrder() {
            const area = document.getElementById("previewArea");
            const newOrder = [];
            const cards = area.querySelectorAll(".file-card");

            cards.forEach((card, index) => {
                const fileId = card.getAttribute("data-id");
                const fileItem = filesData.find((f) => f.id == fileId);
                if (fileItem) {
                    newOrder.push(fileItem);
                    // Update nomor urut
                    const orderElement = card.querySelector(".file-order");
                    if (orderElement) {
                        orderElement.textContent = index + 1;
                    }
                }
            });

            filesData = newOrder;
        }

        function removeFile(id) {
            filesData = filesData.filter((f) => f.id != id);

            // Jika mode rearrange dan file dihapus, reset state
            if (currentTool === "rearrange") {
                pdfDoc = null;
                pageOrder = [];
                originalPageCount = 0;
            }

            renderFiles();
        }

        function clearAll() {
            filesData = [];
            pdfDoc = null;
            pageOrder = [];
            originalPageCount = 0;
            pageRotations.clear();
            selectedPagesForRotation = [];
            document.getElementById("split-range").value = "";
            document.getElementById("rotate-pages").value = "";
            rotationAngle = 0;
            document.getElementById("rotation-val").innerText = "0°";
            renderFiles();
        }

        // --- ROTATION LOGIC ---
        function setRotation(deg) {
            const pagesInput = document.getElementById("rotate-pages");
            let rotationValue = deg;

            // Jika deg adalah 180, kita set langsung
            if (deg === 180) {
                rotationAngle = 180;
            } else {
                rotationAngle = (rotationAngle + deg) % 360;
                if (rotationAngle < 0) rotationAngle += 360;
                rotationValue = rotationAngle;
            }

            document.getElementById("rotation-val").innerText = rotationAngle + "°";

            // Terapkan rotasi ke halaman yang dipilih
            applyRotationToSelectedPages(rotationValue);
        }

        function resetRotation() {
            rotationAngle = 0;
            document.getElementById("rotation-val").innerText = "0°";

            // Reset rotasi untuk halaman yang dipilih
            applyRotationToSelectedPages(0);
        }

 function applyRotationToSelectedPages(angle) {
    // Parse input halaman jika ada
    const pagesInput = document.getElementById("rotate-pages").value.trim();
    if (pagesInput) {
        parsePagesInput(pagesInput);
    }
    
    if (selectedPagesForRotation.length === 0) {
        // Jika tidak ada halaman yang dipilih, pilih semua halaman
        selectedPagesForRotation = Array.from(pageRotations.keys());
    }

    // Normalisasi angle ke 0, 90, 180, atau 270
    let normalizedAngle = angle % 360;
    if (normalizedAngle < 0) normalizedAngle += 360;
    
    // Bulatkan ke kelipatan 90 terdekat
    normalizedAngle = Math.round(normalizedAngle / 90) * 90;
    
    selectedPagesForRotation.forEach((pageIndex) => {
        // Simpan rotasi untuk halaman ini
        pageRotations.set(pageIndex, normalizedAngle);
    });

    // Update rotationAngle global
    rotationAngle = normalizedAngle;
    document.getElementById("rotation-val").innerText = normalizedAngle + "°";

    // Render ulang preview
    if (currentTool === "rotate") {
        renderRotatePreview();
    }
}

function resetToOriginalOrientation() {
    if (filesData.length === 0) return;
    
    // Tanyakan konfirmasi
    if (confirm("Reset all rotations to original orientation (0°)?") === false) {
        return;
    }
    
    // Reset semua rotasi ke 0
    pageRotations.clear();
    
    // Load ulang PDF untuk deteksi ulang rotasi bawaan
    const file = filesData[0].file;
    loadPDFForRotate(file);
    
    showCustomAlert("Success", "All rotations have been reset to 0°.");
}

        // --- CORE PROCESSING LOGIC ---
        async function processFiles() {
            if (filesData.length === 0) {
                showCustomAlert("Warning", "Please upload files first.");
                return;
            }

            showLoading(true);

            try {
                switch (currentTool) {
                    case "merge":
                        await processMerge();
                        break;
                    case "split":
                        await processSplit();
                        break;
                    case "rotate":
                        await processRotate();
                        break;
                    case "img2pdf":
                        await processImg2Pdf();
                        break;
                    case "xls2pdf":
                        await processXls2Pdf();
                        break;
                    case "rearrange":
                        await processRearrange();
                        break;
                }
            } catch (error) {
                console.error("Processing error:", error);
                showCustomAlert("Error", "An error occurred: " + error.message);
            } finally {
                showLoading(false);
            }
        }

        function showLoading(show) {
            document.getElementById("loading").style.display = show
                ? "flex"
                : "none";
        }

        // 1. MERGE PDF
        async function processMerge() {
            if (filesData.length === 0) {
                showCustomAlert(
                    "Warning",
                    "Please add PDF files first."
                );
                return;
            }

            document.getElementById("loading-text").innerText =
                "Merging PDF...";

            const mergedPdf = await PDFDocument.create();

            // Menggunakan urutan file yang telah diatur oleh pengguna
            for (const item of filesData) {
                try {
                    const arrayBuffer = await item.file.arrayBuffer();
                    const pdf = await PDFDocument.load(arrayBuffer);
                    const copiedPages = await mergedPdf.copyPages(
                        pdf,
                        pdf.getPageIndices()
                    );
                    copiedPages.forEach((page) => mergedPdf.addPage(page));
                } catch (error) {
                    console.error("Error processing file:", item.file.name, error);
                    throw error;
                }
            }

            const pdfBytes = await mergedPdf.save();
            download(pdfBytes, "merged_document.pdf", "application/pdf");

            showCustomAlert(
                "Success",
                `Successfully merged ${filesData.length} PDF files.`
            );
        }

        // 2. SPLIT PDF
        async function processSplit() {
            if (filesData.length !== 1) {
                showCustomAlert(
                    "Warning",
                    'Mode "Split PDF" only accepts 1 PDF file   .'
                );
                return;
            }

            const item = filesData[0];
            if (item.file.type !== "application/pdf") {
                showCustomAlert(
                    "Warning",
                    'File must be a PDF for "Split PDF" mode.'
                );
                return;
            }

            const rangeStr = document.getElementById("split-range").value.trim();
            if (!rangeStr) {
                showCustomAlert(
                    "Warning",
                    "Please enter a page range (e.g., 1-3, 5, 7-9)"
                );
                return;
            }

            document.getElementById("loading-text").innerText =
                "Splitting pages...";

            try {
                const arrayBuffer = await item.file.arrayBuffer();
                const originalPdf = await PDFDocument.load(arrayBuffer);
                const totalPages = originalPdf.getPageCount();

                // Parse range
                const ranges = [];
                const parts = rangeStr.split(",");

                for (const part of parts) {
                    const trimmed = part.trim();
                    if (!trimmed) continue;

                    if (trimmed.includes("-")) {
                        const [startStr, endStr] = trimmed
                            .split("-")
                            .map((s) => s.trim());
                        const start = parseInt(startStr);
                        const end = parseInt(endStr);

                        if (isNaN(start) || isNaN(end) || start < 1 || end < 1) {
                            throw new Error(`Invalid range  : ${trimmed}`);
                        }

                        if (start > end) {
                            throw new Error(`Invalid range: ${start} > ${end}`);
                        }

                        if (end > totalPages) {
                            throw new Error(
                                `Page ${end} exceeds total pages (${totalPages})`
                            );
                        }

                        ranges.push({ start, end });
                    } else {
                        const pageNum = parseInt(trimmed);

                        if (isNaN(pageNum) || pageNum < 1) {
                            throw new Error(`Invalid page number: ${trimmed}`);
                        }

                        if (pageNum > totalPages) {
                            throw new Error(
                                `Page ${pageNum} exceeds total pages (${totalPages})`
                            );
                        }

                        ranges.push({ start: pageNum, end: pageNum });
                    }
                }

                if (ranges.length === 0) {
                    throw new Error("No valid pages selected for splitting.");
                }

                const originalName = item.file.name.replace(".pdf", "");
                let createdFiles = 0;

                // Create separate PDFs for each range
                for (let i = 0; i < ranges.length; i++) {
                    const range = ranges[i];
                    const newPdf = await PDFDocument.create();

                    const pageIndices = [];
                    for (let pageNum = range.start; pageNum <= range.end; pageNum++) {
                        pageIndices.push(pageNum - 1);
                    }

                    const copiedPages = await newPdf.copyPages(
                        originalPdf,
                        pageIndices
                    );
                    copiedPages.forEach((page) => newPdf.addPage(page));

                    const pdfBytes = await newPdf.save();

                    let newFilename;
                    if (range.start === range.end) {
                        newFilename = `split_${originalName}_page${range.start}.pdf`;
                    } else {
                        newFilename = `split_${originalName}_pages${range.start}-${range.end}.pdf`;
                    }

                    download(pdfBytes, newFilename, "application/pdf");
                    createdFiles++;

                    if (i < ranges.length - 1) {
                        await new Promise((resolve) => setTimeout(resolve, 100));
                    }
                }

                showCustomAlert(
                    "Success",
                    `Successfully created ${createdFiles} separate PDF files from ${totalPages} total pages.`
                );
            } catch (error) {
                console.error("Split error:", error);
                showCustomAlert(
                    "Error",
                    `Error: ${error.message}\n\nCorrect format:\n• 1-3 (pages 1 to 3)\n• 1,3,5 (pages 1, 3, and 5)\n• 1-3, 5-7 (pages 1-3 and 5-7)`
                );
            }
        }

        // 3. ROTATE PDF
     async function processRotate() {
    if (filesData.length !== 1) {
        showCustomAlert("Warning", 'Mode "Rotate PDF" only accepts 1 PDF file.');
        return;
    }

    document.getElementById("loading-text").innerText = "Rotating pages...";

    try {
        const item = filesData[0];
        const arrayBuffer = await item.file.arrayBuffer();
        const pdf = await PDFDocument.load(arrayBuffer);
        const pages = pdf.getPages();
        const totalPages = pages.length;

        // Tentukan halaman mana yang akan diputar
        let pagesToRotate = selectedPagesForRotation;
        if (pagesToRotate.length === 0) {
            pagesToRotate = Array.from({ length: totalPages }, (_, i) => i);
        }

        const rotationSummary = [];
        let hasChanges = false;

        // Terapkan rotasi ke halaman yang dipilih
        pagesToRotate.forEach((pageIndex) => {
            if (pageIndex >= 0 && pageIndex < totalPages) {
                const page = pages[pageIndex];
                const currentRotation = pageRotations.get(pageIndex) || 0;
                const originalRotation = page.getRotation ? page.getRotation().angle || 0 : 0;

                // Hitung rotasi total (asli + baru)
                const totalRotation = (originalRotation + currentRotation) % 360;
                
                if (currentRotation !== 0) {
                    page.setRotation(degrees(totalRotation));
                    rotationSummary.push({
                        page: pageIndex + 1,
                        original: originalRotation,
                        applied: currentRotation,
                        final: totalRotation
                    });
                    hasChanges = true;
                }
            }
        });

        if (!hasChanges) {
            showCustomAlert("Information", "No rotation changes were applied.");
            showLoading(false);
            return;
        }

        const pdfBytes = await pdf.save();

        // Generate filename yang informatif
        const originalName = item.file.name.replace(/\.pdf$/i, "");
        let filename;
        
        if (pagesToRotate.length === totalPages) {
            filename = `rotated_${originalName}.pdf`;
        } else {
            const pageList = pagesToRotate.map(p => p + 1).sort((a, b) => a - b);
            if (pageList.length <= 5) {
                filename = `rotated_${originalName}_pages${pageList.join('_')}.pdf`;
            } else {
                filename = `rotated_${originalName}_${pagesToRotate.length}pages.pdf`;
            }
        }

        download(pdfBytes, filename, "application/pdf");

        // Tampilkan ringkasan detail
        let summaryMessage = `✅ Successfully processed ${rotationSummary.length} pages.\n\n`;
        summaryMessage += `Total rotation applied: ${rotationAngle}°\n\n`;
        
        if (rotationSummary.length <= 10) {
            summaryMessage += "Detail per page:\n";
            rotationSummary.forEach(summary => {
                summaryMessage += `• Page ${summary.page}: ${summary.original}° + ${summary.applied}° = ${summary.final}°\n`;
            });
        } else {
            summaryMessage += `${rotationSummary.length} pages rotated ${rotationAngle}°\n`;
        }

        showCustomAlert("Rotation Complete", summaryMessage);
    } catch (error) {
        console.error("Rotate error:", error);
        showCustomAlert("Error", `Failed to rotate PDF: ${error.message}`);
    }
}
        // 4. JPG TO PDF
        async function processImg2Pdf() {
            if (filesData.length === 0) {
                showCustomAlert(
                    "Warning",
                    "Please add image files first."
                );
                return;
            }

            document.getElementById("loading-text").innerText =
                "Converting images to PDF...";

            const pdfDoc = await PDFDocument.create();

            // Menggunakan urutan file yang telah diatur oleh pengguna
            for (const item of filesData) {
                try {
                    const imageBytes = await item.file.arrayBuffer();
                    let image;

                    if (item.file.type === "image/jpeg") {
                        image = await pdfDoc.embedJpg(imageBytes);
                    } else if (item.file.type === "image/png") {
                        image = await pdfDoc.embedPng(imageBytes);
                    } else {
                        continue;
                    }

                    const page = pdfDoc.addPage([image.width, image.height]);
                    page.drawImage(image, {
                        x: 0,
                        y: 0,
                        width: image.width,
                        height: image.height,
                    });
                } catch (error) {
                    console.error("Error processing image:", item.file.name, error);
                    showCustomAlert(
                        "Error",
                        `Failed to process image: ${item.file.name}\n${error.message}`
                    );
                    throw error;
                }
            }

            const pdfBytes = await pdfDoc.save();
            download(pdfBytes, "images_combined.pdf", "application/pdf");

            showCustomAlert(
                "Success",
                `Successfully converted ${filesData.length} images to PDF with the specified order.`
            );
        }

        // 5. EXCEL TO PDF
        async function processXls2Pdf() {
            if (filesData.length !== 1) {
                showCustomAlert(
                    "Warning",
                    'Mode "Excel to PDF" only accepts 1 Excel file.'
                );
                return;
            }

            document.getElementById("loading-text").innerText =
                "Converting Excel to PDF...";

            const item = filesData[0];
            const data = await item.file.arrayBuffer();
            const workbook = XLSX.read(data);
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(16);
            doc.text(`File: ${item.file.name}`, 14, 15);

            doc.autoTable({
                head: [jsonData[0]],
                body: jsonData.slice(1),
                startY: 25,
                theme: "grid",
                styles: {
                    fontSize: 8,
                    cellPadding: 2,
                },
                headStyles: {
                    fillColor: [0, 51, 102],
                },
            });

            doc.save(`converted_${item.file.name.split(".")[0]}.pdf`);

            showCustomAlert("Success", "Successfully converted Excel to PDF.");
        }

        // 6. REARRANGE PDF PAGES (dengan hapus halaman)
        async function processRearrange() {
            if (filesData.length !== 1) {
                showCustomAlert(
                    "Warning",
                    'Mode "Rearrange Pages" only accepts 1 PDF file.'
                );
                return;
            }

            if (!pdfDoc || pageOrder.length === 0) {
                showCustomAlert(
                    "Warning",
                    "Please upload a PDF file first."
                );
                return;
            }

            // Validasi jika tidak ada halaman yang tersisa
            if (pageOrder.length === 0) {
                showCustomAlert(
                    "Warning",
                    "No pages are left to process."
                );
                return;
            }

            document.getElementById("loading-text").innerText =
                "Rearranging pages...";

            try {
                // Buat PDF baru dengan urutan halaman yang telah diatur
                const newPdf = await PDFDocument.create();

                // Salin halaman sesuai urutan yang baru
                const copiedPages = await newPdf.copyPages(pdfDoc, pageOrder);
                copiedPages.forEach((page) => newPdf.addPage(page));

                const pdfBytes = await newPdf.save();
                const originalName = filesData[0].file.name.replace(".pdf", "");
                download(
                    pdfBytes,
                    `rearranged_${originalName}.pdf`,
                    "application/pdf"
                );

                // Tampilkan ringkasan perubahan
                let changeSummary = `Successfully rearranged ${originalPageCount} pages.\n\n`;
                changeSummary += `Deleted Pages: ${originalPageCount - pageOrder.length
                    }\n`;
                changeSummary += "New Page Order:\n";

                pageOrder.forEach((originalPage, newIndex) => {
                    changeSummary += `${newIndex + 1}. Page ${originalPage + 1
                        } (original: ${originalPage + 1})\n`;
                });

                showCustomAlert(
                    "Success",
                    `PDF has been created with the new page order.\n\nTotal pages: ${pageOrder.length
                    }\nOriginal pages: ${originalPageCount}\nDeleted pages: ${originalPageCount - pageOrder.length
                    }`
                );
            } catch (error) {
                console.error("Rearrange error:", error);
                showCustomAlert(
                    " Error",
                    `Failed to rearrange pages: ${error.message}`
                );
            }
        }


        // --- DETEKSI ROTASI BERTINGKAT ---
async function detectPageRotation(page) {
    try {
        const pageObj = page; // page dari PDFLib
        
        // Layer 1: Cek metadata rotasi dari PDF
        const metadataRotation = getMetadataRotation(pageObj);
        if (metadataRotation !== 0) {
            console.log(`Layer 1: Metadata rotation detected: ${metadataRotation}°`);
            return metadataRotation;
        }
        
        // Layer 2: Analisis sederhana orientasi konten
        const contentRotation = await analyzeContentOrientation(pageObj);
        if (contentRotation !== 0) {
            console.log(`Layer 2: Content analysis rotation: ${contentRotation}°`);
            return contentRotation;
        }
        
        // Layer 3: Heuristik default (landscape vs portrait)
        const heuristicRotation = heuristicOrientationCheck(pageObj);
        console.log(`Layer 3: Heuristic rotation: ${heuristicRotation}°`);
        
        return heuristicRotation;
        
    } catch (error) {
        console.error("Rotation detection error:", error);
        return 0; // Default no rotation
    }
}

function getMetadataRotation(page) {
    try {
        // Coba ambil rotasi dari properti page
        if (page.getRotation) {
            const rotation = page.getRotation();
            return rotation.angle || 0;
        }
        return 0;
    } catch (e) {
        return 0;
    }
}

async function analyzeContentOrientation(page) {
    try {
        // Ini adalah implementasi sederhana tanpa OCR
        // Untuk implementasi lengkap butuh OCR seperti Tesseract
        
        // Heuristik 1: Perbandingan width vs height
        const { width, height } = page.getSize();
        const isLandscape = width > height;
        
        // Heuristik 2: Periksa jika halaman perlu diputar berdasarkan rasio
        // Jika halaman portrait tapi konten landscape, atau sebaliknya
        const expectedRatio = isLandscape ? 1.4 : 0.7;
        const actualRatio = width / height;
        
        // Jika rasio sangat berbeda dari yang diharapkan
        if (Math.abs(actualRatio - expectedRatio) > 0.5) {
            // Kemungkinan perlu rotasi 90 derajat
            return 90;
        }
        
        return 0;
    } catch (error) {
        return 0;
    }
}

function heuristicOrientationCheck(page) {
    try {
        const { width, height } = page.getSize();
        const ratio = width / height;
        
        // Jika halaman sangat lebar (landscape), tetapi secara teknis portrait
        if (ratio > 1.5 && width < height) {
            return 90; // Rotasi diperlukan
        }
        
        // Jika halaman sangat tinggi (portrait), tetapi secara teknis landscape
        if (ratio < 0.67 && width > height) {
            return -90; // Rotasi diperlukan
        }
        
        return 0;
    } catch (error) {
        return 0;
    }
}

        // Initialize
        document.addEventListener("DOMContentLoaded", function () {
            // Set default tool
            switchTool("merge");

            // Setup file input untuk semua mode
            const fileInput = document.getElementById("fileInput");
            fileInput.accept =
                currentTool === "img2pdf"
                    ? "image/*"
                    : currentTool === "xls2pdf"
                        ? ".xlsx,.xls"
                        : currentTool === "rearrange"
                            ? ".pdf"
                            : ".pdf,image/*";

            // Update file input accept ketika tool berubah
            document.querySelectorAll(".tool-card").forEach((card) => {
                card.addEventListener("click", function () {
                    setTimeout(() => {
                        const tool = currentTool;
                        fileInput.accept =
                            tool === "img2pdf"
                                ? "image/*"
                                : tool === "xls2pdf"
                                    ? ".xlsx,.xls"
                                    : tool === "rearrange"
                                        ? ".pdf"
                                        : ".pdf,image/*";
                    }, 100);
                });
            });

            // Close modal konfirmasi hapus jika klik di luar modal
            document
                .getElementById("deleteConfirmation")
                .addEventListener("click", function (e) {
                    if (e.target === this) {
                        cancelDelete();
                    }
                });
        });
    </script>
</body>

</html>